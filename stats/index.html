<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isabuhay Tournament Stats</title>
    <link rel="stylesheet" href="stats.css">
</head>
<body>
    <div class="container">
        <h1>üèÜ Isabuhay Tournament Stats</h1>
        <p class="subtitle">Comprehensive statistics from 2013 to 2024</p>
        
        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search for players...">
        </div>

        <div class="stats-container">
            <div class="stat-box">
                <h3>Total Tournaments</h3>
                <div class="stat-value" id="totalTournaments">-</div>
                <p>From 2013 to 2024</p>
            </div>
            <div class="stat-box">
                <h3>Total Players</h3>
                <div class="stat-value" id="totalPlayers">-</div>
                <p>Unique participants</p>
            </div>
            <div class="stat-box">
                <h3>Most Championships</h3>
                <div class="stat-value" id="mostChampionships">-</div>
                <p>Record holder</p>
            </div>
            <div class="stat-box">
                <h3>Most Wins</h3>
                <div class="stat-value" id="mostWins">-</div>
                <p>All-time wins leader</p>
            </div>
            <div class="stat-box">
                <h3>The Gatekeeper</h3>
                <div class="stat-value" id="gatekeeper">-</div>
                <p>Most wins without a championship</p>
            </div>
            <div class="stat-box">
                <h3>Underdog Champion</h3>
                <div class="stat-value" id="underdogChampion">-</div>
                <p>Champion with the lowest win rate</p>
            </div>
            <div class="stat-box">
                <h3>One-Hit Wonder</h3>
                <div class="stat-value" id="oneHitWonder">-</div>
                <p>Won a championship in their only appearance</p>
            </div>
        </div>

        <div class="player-stats">
            <h2>Player Statistics</h2>
            <div class="table-container">
                <table id="playerTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Win Rate</th>
                            <th>Best Streak</th>
                        <th>Current Streak</th>
                            <th>Tournaments</th>
                            <th>Championships</th>
                            <th>Overall</th>
                        </tr>
                    </thead>
                    <tbody id="playerTableBody">
                        <!-- Player data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="formula-explanation">
            <h3>üèÜ Overall Performance Formula üèÜ</h3>
            <p>This score is a weighted average of eight key factors, each representing a different aspect of a player's career and skill.</p>
            
            <h4>Formula Breakdown:</h4>
            <ul>
                <li><strong>Win Volume (20%):</strong> Measures a player's total number of wins.</li>
                <li><strong>Championship Rate (18%):</strong> Measures a player's efficiency at winning championships.</li>
                <li><strong>Peak Performance (17%):</strong> Measures a player's longest winning streak.</li>
                <li><strong>Consistency (15%):</strong> A player's overall win rate.</li>
                <li><strong>Experience (11%):</strong> Rewards players for their longevity and tournament appearances.</li>
                <li><strong>Current Form (8%):</strong> Measures a player's recent momentum (win/loss streak).</li>
                <li><strong>Prime Performance (7%):</strong> Rewards players for winning championships in more recent, competitive years.</li>
                <li><strong>Championship Bonus (5%):</strong> Provides extra points for winning multiple championships.</li>
            </ul>
        </div>
    </div>

    <script>
        // Global variable to store player data
        let allPlayers = {};
        const years = [2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024];
        let filesLoaded = 0;

        // Function to load and process JSON files
        async function loadTournamentData() {
            const promises = years.map(year => {
                const filename = year === 2013 ? 'Isabuhay-2013.json' : `Isabuhay-${year}.json`;
                
                // For your structure: /stats/index.html needs to access /isabuhay/*.json
                // Try both relative and absolute paths
                const possibleUrls = [
                    `../isabuhay/${filename}`,     // Relative path (go up one level, then into isabuhay)
                    `/isabuhay/${filename}`,       // Absolute path (your current approach)
                    `./isabuhay/${filename}`,      // Just in case
                ];
                
                const tryFetch = async (urls) => {
                    for (const url of urls) {
                        try {
                            console.log(`Trying to fetch: ${url}`);
                            const response = await fetch(url);
                            if (response.ok) {
                                console.log(`Successfully loaded: ${url}`);
                                return await response.json();
                            } else {
                                console.warn(`Failed to load ${url}: ${response.status} ${response.statusText}`);
                            }
                        } catch (error) {
                            console.warn(`Error fetching ${url}:`, error.message);
                        }
                    }
                    throw new Error(`Could not load ${filename} from any URL`);
                };
                
                return tryFetch(possibleUrls)
                    .then(data => {
                        processTournamentData(data, year);
                        return { year, success: true };
                    })
                    .catch(error => {
                        console.error(`Error loading data for ${year}:`, error);
                        return { year, success: false, error };
                    });
            });

            const results = await Promise.allSettled(promises);
            
            // Log results for debugging
            results.forEach((result, index) => {
                if (result.status === 'fulfilled') {
                    console.log(`Year ${years[index]}: ${result.value.success ? 'Success' : 'Failed'}`);
                }
            });
            
            updateUI();
        }
        
        // Process data from a single tournament
        function processTournamentData(tournamentData, year) {
            const playerStats = tournamentData.playerStats;

            for (const name in playerStats) {
                const stats = playerStats[name];
                if (!allPlayers[name]) {
                    allPlayers[name] = {
                        name: name,
                        totalWins: 0,
                        totalLosses: 0,
                        tournaments: 0,
                        championships: 0,
                        championshipYears: [],
                        history: [],
                        lastChampionshipYear: 0
                    };
                }

                const player = allPlayers[name];
                player.totalWins += stats.totalWins;
                player.totalLosses += stats.totalLosses;
                player.tournaments += stats.tournaments;
                player.championships += stats.championships;
                if (stats.championships > 0) {
                    player.lastChampionshipYear = Math.max(player.lastChampionshipYear || 0, year);
                    player.championshipYears.push(year);
                }

                player.history.push({
                    year: year,
                    isChampion: stats.championships === 1,
                    wins: stats.totalWins,
                    losses: stats.totalLosses
                });
            }
        }

        // Update the UI with the processed data
        function updateUI() {
            const playerTableBody = document.getElementById('playerTableBody');
            playerTableBody.innerHTML = ''; // Clear existing table data

            // Step 1: Pre-calculate stats for all players
            let playersArray = Object.values(allPlayers).map(player => {
                const winRate = player.totalWins + player.totalLosses > 0 
                    ? Math.round((player.totalWins / (player.totalWins + player.totalLosses)) * 100) 
                    : 0;

                let bestStreak = 0;
                let currentStreak = 0;
                let tempStreak = 0;

                if (player.history && player.history.length > 0) {
                    player.history.sort((a, b) => a.year - b.year);
                    player.history.forEach(tourney => {
                        for (let i = 0; i < tourney.wins; i++) {
                            if (tempStreak < 0) tempStreak = 0;
                            tempStreak++;
                        }
                        for (let i = 0; i < tourney.losses; i++) {
                            bestStreak = Math.max(bestStreak, tempStreak);
                            if (tempStreak > 0) tempStreak = 0;
                            tempStreak--;
                        }
                    });
                    bestStreak = Math.max(bestStreak, tempStreak);
                    currentStreak = tempStreak;
                }

                return {
                    ...player,
                    winRate,
                    bestStreak,
                    currentStreak
                };
            });

            // Step 2: Calculate overall score for each player
            playersArray = playersArray.map(player => ({
                ...player,
                overallScore: calculateOverallPerformance(player, playersArray)
            }));

            // Step 3: Sort players by the new overall score
            playersArray.sort((a, b) => b.overallScore - a.overallScore);

            // Update summary stats
            document.getElementById('totalTournaments').textContent = years.length;
            document.getElementById('totalPlayers').textContent = playersArray.length;

            const mostChampionships = playersArray.reduce((max, p) => p.championships > max.championships ? p : max, { championships: 0 });
            document.getElementById('mostChampionships').innerHTML = mostChampionships.name ? `${mostChampionships.name} <span class="champion">(${mostChampionships.championships})</span>` : 'N/A';

            const mostWins = playersArray.reduce((max, p) => p.totalWins > max.totalWins ? p : max, { totalWins: 0 });
            document.getElementById('mostWins').innerHTML = mostWins.name ? `${mostWins.name} <span class="positive">(${mostWins.totalWins})</span>` : 'N/A';

            const noChampionships = playersArray.filter(p => p.championships === 0 && p.totalWins > 0);
            const gatekeeper = noChampionships.length > 0 ? noChampionships.reduce((max, p) => p.totalWins > max.totalWins ? p : max) : null;
            document.getElementById('gatekeeper').innerHTML = gatekeeper ? `${gatekeeper.name} <span class="positive">(${gatekeeper.totalWins} wins)</span>` : 'N/A';

            const champions = playersArray.filter(p => p.championships > 0);
            const underdogChampion = champions.length > 0 ? champions.reduce((min, p) => p.winRate < min.winRate ? p : min) : null;
            document.getElementById('underdogChampion').innerHTML = underdogChampion ? `${underdogChampion.name} <span class="negative">(${underdogChampion.winRate}%)</span>` : 'N/A';

            const oneHitWonders = playersArray.filter(p => p.tournaments === 1 && p.championships === 1);
            if (oneHitWonders.length > 0) {
                const namesList = oneHitWonders.map(p => p.name).join(', ');
                document.getElementById('oneHitWonder').innerHTML = `${namesList} <span class="champion">(1√ó appearance & title)</span>`;
            } else {
                document.getElementById('oneHitWonder').innerHTML = 'N/A';
            }

            // Step 4: Populate the table
            playersArray.forEach(player => {
                const row = document.createElement('tr');
                
                let bestStreakDisplay = player.bestStreak > 0 ? `<span class="positive">+${player.bestStreak}</span>` : '0';
                let currentStreakDisplay;
                if (player.currentStreak > 0) {
                    currentStreakDisplay = `<span class="positive">+${player.currentStreak}</span>`;
                } else if (player.currentStreak < 0) {
                    currentStreakDisplay = `<span class="negative">${player.currentStreak}</span>`;
                } else {
                    currentStreakDisplay = '0';
                }
                
                if (player.championships > 0) {
                    row.classList.add('champion-row');
                }
                
                let championshipsDisplay = player.championships;
                if (player.championships > 0 && player.championshipYears.length > 0) {
                    championshipsDisplay = `${player.championships} (${player.championshipYears.join(', ')})`;
                }

                row.innerHTML = `
                    <td class="${player.championships > 0 ? 'champion' : ''}">${player.name}</td>
                    <td>${player.totalWins}</td>
                    <td>${player.totalLosses}</td>
                    <td>${player.winRate}%</td>
                    <td>${bestStreakDisplay}</td>
                    <td>${currentStreakDisplay}</td>
                    <td>${player.tournaments}</td>
                    <td class="champion">${championshipsDisplay}</td>
                    <td><div class="overall-score">${player.overallScore}</div></td>
                `;
                playerTableBody.appendChild(row);
            });
        }

        function calculateOverallPerformance(player, playersArray) {
            // Win Volume (22% weight) - Total wins matter in battle rap
            const maxWins = Math.max(...playersArray.map(p => p.totalWins));
            const winVolume = maxWins > 0 ? (player.totalWins / maxWins) * 100 : 0;
            
            // Championship Rate (20% weight) - Efficiency at winning titles
            const championshipRate = player.tournaments > 0 ? (player.championships / player.tournaments) * 100 : 0;
            
            // Peak Performance (18% weight) - Best streak shows legendary potential
            const maxBestStreak = Math.max(...playersArray.map(p => p.bestStreak));
            const peakPerformance = maxBestStreak > 0 ? (player.bestStreak / maxBestStreak) * 100 : 0;
            
            // Consistency (15% weight) - Win rate as baseline skill
            const consistency = player.winRate;
            
            // Experience (12% weight) - Tournament participation
            const maxTournaments = Math.max(...playersArray.map(p => p.tournaments));
            const experience = maxTournaments > 0 ? (player.tournaments / maxTournaments) * 100 : 0;
            
            // Current Form (8% weight) - Recent momentum
            let currentForm = 50; // Base form
            if (player.currentStreak > 0) {
                currentForm += Math.min(player.currentStreak * 12.5, 50); // Max +50 for 4+ streak
            } else if (player.currentStreak < 0) {
                currentForm -= Math.min(Math.abs(player.currentStreak) * 25, 40); // Max -40 for loss streaks
            }
            
            // Championship Bonus (5% weight) - Extra points for multiple titles
            const championshipBonus = player.championships > 1 ? ((player.championships - 1) * 20) : 0;

            // Prime Performance (7% weight) - Rewards recent championships
            let primePerformance = 0;
            if (player.lastChampionshipYear) {
                const minYear = 2013;
                const maxYear = 2024;
                primePerformance = ((player.lastChampionshipYear - minYear) / (maxYear - minYear)) * 100;
            }
            
            // Calculate weighted overall score
            const overallScore = (
                (winVolume * 0.20) +          // was 0.22
                (championshipRate * 0.18) +   // was 0.20
                (peakPerformance * 0.17) +    // was 0.18
                (consistency * 0.15) +
                (experience * 0.11) +         // was 0.12
                (currentForm * 0.08) +
                (championshipBonus * 0.05) +
                (primePerformance * 0.07)     // new
            );
            
            return Math.round(overallScore * 10) / 10;
        }

        // Search functionality
        function searchTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('playerTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }       
            }
        }

        // Load data when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', loadTournamentData);
    </script>
</body>
</html>
